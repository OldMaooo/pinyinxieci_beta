<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æŒæ¡çŠ¶æ€è°ƒè¯•å·¥å…·</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: -apple-system, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
    .stats-row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-box { background: #f0f0f0; padding: 15px 25px; border-radius: 8px; text-align: center; min-width: 120px; }
    .stat-box h3 { margin: 0 0 5px 0; font-size: 14px; color: #666; }
    .stat-box .num { font-size: 32px; font-weight: bold; }
    .stat-box.mastered { background: #dcfce7; }
    .stat-box.weak { background: #fee2e2; }
    .stat-box.new { background: #f3f4f6; }
    .stat-box.today { background: #dbeafe; }

    .controls { margin: 20px 0; padding: 15px; background: #fffbeb; border-radius: 8px; }
    .controls button { padding: 8px 16px; margin-right: 10px; cursor: pointer; border: 1px solid #ddd; border-radius: 4px; background: white; }
    .controls button:hover { background: #f5f5f5; }
    .controls button.primary { background: #3b82f6; color: white; border: none; }

    .word-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px; }
    .word-card { padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb; font-size: 14px; }
    .word-card.mastered { background: #dcfce7; border-color: #86efac; }
    .word-card.weak { background: #fee2e2; border-color: #fca5a5; }
    .word-card.new { background: #f9fafb; border-color: #e5e7eb; }
    .word-card.today { border-color: #3b82f6; border-width: 2px; }

    .word-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; }
    .word-id { font-size: 10px; color: #999; font-family: monospace; }
    .word-details { font-size: 12px; color: #666; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
    .word-details span { background: rgba(255,255,255,0.5); padding: 2px 6px; border-radius: 3px; }

    .history { margin-top: 5px; font-family: monospace; font-size: 11px; background: rgba(0,0,0,0.05); padding: 3px 6px; border-radius: 3px; overflow-x: auto; white-space: nowrap; }

    .filter-row { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
    .filter-row input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-width: 200px; }
    .error { background: #fee2e2; color: #dc2626; padding: 10px; border-radius: 6px; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>ğŸ“Š æŒæ¡çŠ¶æ€è°ƒè¯•å·¥å…·</h1>

  <div id="error-area"></div>

  <div class="stats-row">
    <div class="stat-box mastered">
      <h3>âœ… æŒæ¡ (è¿ç»­â‰¥5å¤©)</h3>
      <div class="num" id="count-mastered">-</div>
    </div>
    <div class="stat-box weak">
      <h3>âŒ è–„å¼± (æœ€åé”™)</h3>
      <div class="num" id="count-weak">-</div>
    </div>
    <div class="stat-box new">
      <h3>ğŸ†• æ–°è¯/åˆšå¯¹</h3>
      <div class="num" id="count-new">-</div>
    </div>
    <div class="stat-box today">
      <h3>ğŸ“… ä»Šå¤©ç»ƒè¿‡</h3>
      <div class="num" id="count-today">-</div>
    </div>
  </div>

  <div class="controls">
    <button class="primary" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
    <button onclick="showMastered()">åªçœ‹æŒæ¡</button>
    <button onclick="showWeak()">åªçœ‹è–„å¼±</button>
    <button onclick="showAll()">æ˜¾ç¤ºå…¨éƒ¨</button>
    <button onclick="clearFilter()">æ¸…é™¤ç­›é€‰</button>
  </div>

  <div class="filter-row">
    <input type="text" id="search" placeholder="æœç´¢è¯è¯­..." oninput="filterWords()">
    <span id="filter-status"></span>
  </div>

  <div class="word-list" id="word-list"></div>

  <script>
    const SUPABASE_URL = 'https://ynasoxvdalcmrrsxxmjr.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_ap2IKSLCxabTzVTQNbw45Q_iFBUaNJW';

    // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let allData = [];
    let todayStr = new Date().toISOString().split('T')[0];

    async function loadData() {
      console.log('ğŸ“¡ æ­£åœ¨åŠ è½½æ•°æ®...');
      document.getElementById('error-area').innerHTML = '';

      const { data, error } = await client
        .from('mastery_records')
        .select('id, history, consecutive_green, last_practice_date, temp_state')
        .range(0, 9999);

      if (error) {
        console.error('âŒ åŠ è½½å¤±è´¥:', error);
        document.getElementById('error-area').innerHTML = `<div class="error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
        return;
      }

      console.log(`âœ… åŠ è½½äº† ${data.length} æ¡è®°å½•`);
      allData = data;
      renderAll();
    }

    function getStatus(record) {
      if (!record || !record.history || record.history.length === 0) {
        return 'NEW';
      }

      const consecutiveGreen = record.consecutive_green || 0;
      const lastResult = record.history[record.history.length - 1];

      if (consecutiveGreen >= 5) {
        return 'MASTERED';
      } else if (lastResult === 'red') {
        return 'WEAK';
      } else {
        return 'NEW';
      }
    }

    function renderAll() {
      const stats = { mastered: 0, weak: 0, new: 0, today: 0 };
      const list = document.getElementById('word-list');
      list.innerHTML = '';

      const searchTerm = document.getElementById('search').value.toLowerCase();
      let filteredCount = 0;

      allData.forEach(record => {
        const status = getStatus(record);
        const isToday = record.last_practice_date === todayStr;

        if (status === 'MASTERED') stats.mastered++;
        else if (status === 'WEAK') stats.weak++;
        else stats.new++;

        if (isToday) stats.today++;

        // æœç´¢è¿‡æ»¤
        const word = record.id.split('-').pop() || record.id;
        if (searchTerm && !word.includes(searchTerm)) return;

        filteredCount++;

        const div = document.createElement('div');
        div.className = `word-card ${status.toLowerCase()} ${isToday ? 'today' : ''}`;
        div.innerHTML = `
          <div class="word-header">
            <span>${word}</span>
            <span class="word-id">${status}</span>
          </div>
          <div class="word-details">
            <span>ğŸ“… è¿ç»­: ${record.consecutive_green || 0}å¤©</span>
            <span>ğŸ“ ç»ƒä¹ : ${record.last_practice_date || 'ä»æœª'}</span>
          </div>
          <div class="history">å†å²: [${(record.history || []).slice(-5).join(', ')}]</div>
        `;
        div.onclick = () => showDetail(record);
        list.appendChild(div);
      });

      document.getElementById('count-mastered').textContent = stats.mastered;
      document.getElementById('count-weak').textContent = stats.weak;
      document.getElementById('count-new').textContent = stats.new;
      document.getElementById('count-today').textContent = stats.today;
      document.getElementById('filter-status').textContent = `æ˜¾ç¤º ${filteredCount}/${allData.length} ä¸ªè¯`;
    }

    function showDetail(record) {
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log(`ğŸ“ è¯è¯­: ${record.id.split('-').pop()}`);
      console.log(`ğŸ†” ID: ${record.id}`);
      console.log(`ğŸ“Š çŠ¶æ€: ${getStatus(record)}`);
      console.log(`ğŸ“… è¿ç»­ç»¿: ${record.consecutive_green || 0} å¤©`);
      console.log(`ğŸ“ æœ€åç»ƒä¹ : ${record.last_practice_date || 'ä»æœª'}`);
      console.log(`ğŸ“‹ å†å²è®°å½•: [${(record.history || []).join(', ')}]`);
      console.log(`ğŸ¯ ä¸´æ—¶çŠ¶æ€: ${JSON.stringify(record.temp_state || {})}`);
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

      alert(`ğŸ“ ${record.id.split('-').pop()}\n\n` +
        `çŠ¶æ€: ${getStatus(record)}\n` +
        `è¿ç»­ç»¿: ${record.consecutive_green || 0}å¤©\n` +
        `æœ€åç»ƒä¹ : ${record.last_practice_date || 'ä»æœª'}\n` +
        `å†å²: [${(record.history || []).join(', ')}]`);
    }

    function showMastered() {
      document.getElementById('search').value = 'ğŸ¯ MASTERED_ONLY';
      renderAll();
    }

    function showWeak() {
      document.getElementById('search').value = 'ğŸ¯ WEAK_ONLY';
      renderAll();
    }

    function showAll() {
      document.getElementById('search').value = '';
      renderAll();
    }

    function clearFilter() {
      document.getElementById('search').value = '';
      renderAll();
    }

    function filterWords() {
      renderAll();
    }

    // åˆå§‹åŠ è½½
    loadData();
  </script>
</body>
</html>
