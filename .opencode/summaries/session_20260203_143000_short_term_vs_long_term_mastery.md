# Session Summary: 短期 vs 长期掌握区分方案规划

## Session 信息

- **Session ID**: session_20260203_143000_short_term_vs_long_term_mastery
- **日期**: 2026-02-03 14:30:00
- **主题**: 短期 vs 长期掌握区分方案规划
- **状态**: 已完成（规划阶段）

---

## 关键进展

### 背景问题识别
- **标记混淆**：无法区分「本轮错题」和「历史错题」
- **筛选失效**：筛选「仅错题」时，混入已掌握的题目
- **逻辑不清**：短期标记和长期记录混在一起

### 核心需求定义
1. **短期标记**：本轮练习的临时标记，结束后清空显示状态
2. **长期记录**：连续 5 天每天都答对 = 真掌握
3. **红色优先规则**：一旦今天标记过红色，今天结果就是 "red"（不可逆）

### 关键技术决策

#### 1. 数据结构设计
```javascript
// 长期记录（mastery 表）
{
  id: "wordId",
  history: ["green", "green", "red", "green", "green"],  // 每天的结果
  consecutive_green: 3,            // 当前连续绿色天数（>=5 = 掌握）
  last_practice_date: "2026-01-29", // 最后练习日期
  today_red_marked: false          // 追踪今天是否标记过红色（跨测试）
}

// 短期标记（本轮练习状态）
{
  id: "wordId",
  word: "词语",
  pinyin: "pīn yīn",
  temp_practice: "white" | "red",   // 本轮自由练习标记
  temp_self: "white" | "red",       // 本轮自测标记
  temp_final: "white" | "red" | "green"  // 本轮终测标记（决定性）
}
```

#### 2. 核心逻辑
- **进入练习时**：判断是否新的一天，清空短期标记
- **本轮练习中**：实时更新短期标记，追踪今天红色标记
- **保存时**：根据 today_red_marked 写入历史记录
- **红色优先**：绿色不能覆盖红色

#### 3. 案例验证

##### 场景 1：连续 5 天答对 → 掌握
- D1-D5 每天都答对 → consecutive_green = 5 → MASTERED

##### 场景 2：中途答错 → 打断连胜
- D1 答对 → consecutive_green = 1
- D2 答错 → consecutive_green = 0（重置）

##### 场景 3：红色优先于绿色
- D1 第1轮 green → history = ["green"]
- D1 第2轮 red → history = ["red"]（覆盖）
- D1 第3轮 green → history = ["red"]（保持，绿色不能覆盖红色）
- D2 第1轮 green → history = ["red", "green"]（明天重新开始）

### UI 展示设计方案

#### Setup 页词汇总表
| 长期状态 | 文字颜色 | 下划线 | 说明 |
|----------|----------|--------|------|
| NEW（未测试） | 黑色 | 无 | 默认 |
| WEAK（错的/中断） | 红色 | **红色实线** | 当前方案 |
| MASTERED（掌握） | 绿色 | **绿色实线** | 当前方案 |

#### 练习页（开始做题前）
| 词组类型 | 文字颜色 | 框框 | 说明 |
|----------|----------|------|------|
| WEAK（未掌握） | **淡红色** | 白色 | 提示需要关注 |
| NEW / MASTERED | 黑色 | 白色 | 正常显示 |
| 本轮标记错 | 淡红 | **红色** | 本轮标记 |
| 本轮标记对 | 黑色 | **绿色** | 本轮标记 |

#### 闪卡模式
| 词组类型 | 文字颜色 | 说明 |
|----------|----------|------|
| WEAK（未掌握） | **淡红色** | 提示需要关注 |
| NEW / MASTERED | 黑色 | 正常显示 |
| 本轮错题 | **纯红色** | 当前方案，不改 |

### 重要规则确认
- **NEW 状态**：保持黑色（无标记）
- **只强调未掌握**：掌握状态不特别处理
- **红色优先于绿色**：标记过红色 = 今天 red，不可逆

---

## 当前状态

- **位置**: 规划完成，等待执行
- **下一步**: 执行计划（运行阶段 1-6）
- **问题**: 无

---

## 技术要点

### 数据库变更
- 添加 `last_practice_date` 字段
- 添加 `consecutive_green` 字段
- 保持 `history` 字段含义调整

### 核心函数修改
- `start` 函数：判断是否新的一天
- `save` 函数：写入历史记录，红色优先
- `getStatus` 函数：基于 consecutive_green 判断掌握
- UI 组件：状态展示逻辑调整

### 文件位置
- **主计划**: `.sisyphus/plans/short-term-vs-long-term-mastery.md`
- **案例文档**: `.sisyphus/plans/short-term-vs-long-term-cases.md`

---

## 待办事项

- [x] 规划阶段完成（当前）
- [ ] 阶段 1：数据库迁移
  - [ ] 1.1 添加 `last_practice_date` 字段
  - [ ] 1.2 更新 `history` 字段含义
- [ ] 阶段 2：数据初始化脚本
  - [ ] 2.1 创建迁移脚本
  - [ ] 2.2 执行迁移脚本
- [ ] 阶段 3：核心逻辑修改
  - [ ] 3.1 修改 `start` 函数
  - [ ] 3.2 修改 `getStatus` 函数
  - [ ] 3.3 修改 `save` 函数
- [ ] 阶段 4：UI 展示修改
  - [ ] 4.1 修改 setup 页面状态展示
  - [ ] 4.2 修改练习页面状态展示
  - [ ] 4.3 修改闪卡模式状态展示
  - [ ] 4.4 优化「仅错题」筛选逻辑
- [ ] 阶段 5：测试验证
  - [ ] 5.1 测试新的一天进入逻辑
  - [ ] 5.2 测试短期标记逻辑
  - [ ] 5.3 测试长期记录逻辑
  - [ ] 5.4 测试状态判断
  - [ ] 5.5 测试展示效果
- [ ] 阶段 6：文档更新
  - [ ] 6.1 更新 AGENTS.md
  - [ ] 6.2 更新错题集
  - [ ] 6.3 更新 PROJECT_STATUS.md

---

## 已解决问题

- ✅ 短期和长期标记的区分逻辑
- ✅ 红色优先规则的确定
- ✅ 展示设计方案确认
- ✅ 案例验证完整性
- ✅ 规划文档生成（主计划 + 案例）

---

## 备注

**启动命令**:
```bash
cd /Users/mao/Documents/Coding/Development/Projects/Web/kanpinyinxieci_semiauto
npm run dev  # 端口 3009
```

**执行计划**: 按照 todo 列表顺序执行 6 个阶段

**参考文档**:
- `.sisyphus/plans/short-term-vs-long-term-mastery.md` - 主计划
- `.sisyphus/plans/short-term-vs-long-term-cases.md` - 案例验证
- `AGENTS.md` - 用户信息
