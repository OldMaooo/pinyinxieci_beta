<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>备份数据</title>
</head>
<body>
  <h1>正在备份 Supabase 数据...</h1>
  <p id="status">初始化中...</p>
  <pre id="result"></pre>

  <script>
    const SUPABASE_URL = 'https://ynasoxvdalcmrrsxxmjr.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_ap2IKSLCxabTzVTQNbw45Q_iFBUaNJW';

    async function backup() {
      const status = document.getElementById('status');
      const result = document.getElementById('result');

      try {
        status.textContent = '正在连接 Supabase...';

        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/mastery_records?select=*&limit=10000`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json'
            }
          }
        );

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        
        let mastered = 0, weak = 0, newWords = 0;
        data.forEach(r => {
          if (!r.history || r.history.length === 0) newWords++;
          else if (r.history.slice(-3).includes('red')) weak++;
          else mastered++;
        });

        status.textContent = `成功！共 ${data.length} 条记录`;

        result.textContent = `
统计:
  已掌握 (MASTERED): ${mastered}
  薄弱 (WEAK): ${weak}
  新词 (NEW): ${newWords}
  总计: ${data.length}

正在下载备份文件...
        `.trim();

        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
        const backupData = {
          exportDate: new Date().toISOString(),
          source: SUPABASE_URL,
          totalRecords: data.length,
          stats: { mastered, weak, new: newWords },
          records: data
        };

        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `mastery-backup-${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        status.textContent = '✓ 备份完成！文件已下载';
        result.textContent += '\n\n✓ 文件名: mastery-backup-' + timestamp + '.json';

      } catch (error) {
        status.textContent = '✗ 备份失败';
        result.textContent = '错误: ' + error.message;
        console.error('Backup error:', error);
      }
    }

    window.onload = backup;
  </script>
</body>
</html>
