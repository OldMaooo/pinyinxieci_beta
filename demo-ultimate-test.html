<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­éŸ³ç»ˆææµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f0f9ff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }
        h1 {
            color: #0369a1;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #64748b;
            margin-bottom: 40px;
        }
        .container {
            max-width: 700px;
            width: 100%;
        }
        .test-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .test-section h2 {
            color: #1e40af;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        .btn-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        button {
            padding: 14px 20px;
            border-radius: 8px;
            border: none;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .btn-purple {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }
        .status {
            padding: 12px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
            margin-top: 10px;
        }
        .status-info {
            background: #dbeafe;
            color: #1e40af;
        }
        .status-success {
            background: #d1fae5;
            color: #065f46;
        }
        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }
        .voice-selector {
            margin-bottom: 15px;
        }
        .voice-selector label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
        }
        .voice-selector select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 2px solid #e5e7eb;
            font-size: 1em;
            max-height: 200px;
        }
        .debug-console {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            color: #94a3b8;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85em;
            max-height: 400px;
            overflow-y: auto;
        }
        .debug-console h3 {
            color: #e2e8f0;
            margin-bottom: 10px;
            font-size: 1em;
        }
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #334155;
        }
        .log-time {
            color: #64748b;
            margin-right: 8px;
        }
        .log-info { color: #60a5fa; }
        .log-success { color: #4ade80; }
        .log-error { color: #f87171; }
        .log-warning { color: #fbbf24; }
    </style>
</head>
<body>
    <h1>ğŸ”¬ TTS ç»ˆæè¯Šæ–­å·¥å…·</h1>
    <p class="subtitle">è§£å†³ Chrome/macOS speechSynthesis ä¸æ’­æ”¾é—®é¢˜</p>

    <div class="container">
        <!-- Test 1: Voice Selection -->
        <div class="test-section">
            <h2>1ï¸âƒ£ é€‰æ‹©è¯­éŸ³å¼•æ“</h2>
            <div class="voice-selector">
                <label for="voiceSelect">ä¸­æ–‡è¯­éŸ³åˆ—è¡¨:</label>
                <select id="voiceSelect" onchange="updateSelectedVoice()"></select>
            </div>
            <div class="status status-info" id="voiceStatus">
                åŠ è½½ä¸­...
            </div>
        </div>

        <!-- Test 2: Keep Alive -->
        <div class="test-section">
            <h2>2ï¸âƒ£ æ–¹æ³•A: Keep-Alive æœºåˆ¶</h2>
            <p style="margin-bottom: 15px; color: #64748b;">
                Chrome æœ‰ bugï¼š15ç§’å speechSynthesis ä¼šåœæ­¢å·¥ä½œã€‚è¿™ä¸ªæ–¹æ³•æ¯éš”14ç§’æ’­æ”¾ä¸€ä¸ªæ— å£°éŸ³é¢‘æ¥ä¿æŒå¼•æ“æ´»è·ƒã€‚
            </p>
            <div class="btn-grid">
                <button class="btn-success" id="startKeepAlive" onclick="startKeepAlive()">â–¶ï¸ å¯åŠ¨ Keep-Alive</button>
                <button class="btn-danger" id="stopKeepAlive" onclick="stopKeepAlive()" disabled>â¹ï¸ åœæ­¢ Keep-Alive</button>
                <button class="btn-primary" onclick="testKeepAlive()">ğŸ”Š æµ‹è¯•æ’­æ”¾ï¼ˆéœ€è¦å…ˆå¯åŠ¨ï¼‰</button>
            </div>
            <div class="status status-info" id="keepAliveStatus">
                æœªå¯åŠ¨
            </div>
        </div>

        <!-- Test 3: Full Reset + Simple Utterance -->
        <div class="test-section">
            <h2>3ï¸âƒ£ æ–¹æ³•B: å®Œå…¨é‡ç½® + ç®€å•çŸ­è¯­</h2>
            <p style="margin-bottom: 15px; color: #64748b;">
                å–æ¶ˆæ‰€æœ‰è¯­éŸ³ï¼Œç„¶åæ’­æ”¾æœ€ç®€å•çš„çŸ­è¯­ï¼Œä¸è®¾ç½®ä»»ä½•é¢å¤–å‚æ•°ã€‚
            </p>
            <div class="btn-grid">
                <button class="btn-warning" onclick="fullResetAndSpeak()">ğŸ”„ å®Œå…¨é‡ç½®å¹¶æ’­æ”¾</button>
                <button class="btn-primary" onclick="simpleSpeak()">ğŸ¤ ç®€å•æ’­æ”¾ï¼ˆä¸­æ–‡ï¼‰</button>
                <button class="btn-purple" onclick="simpleSpeakEnglish()">ğŸ¤ ç®€å•æ’­æ”¾ï¼ˆè‹±æ–‡ï¼‰</button>
            </div>
            <div class="status status-info" id="simpleStatus">
                æœªæµ‹è¯•
            </div>
        </div>

        <!-- Test 4: Alternative Approaches -->
        <div class="test-section">
            <h2>4ï¸âƒ£ æ–¹æ³•C: å¤‡ç”¨æ–¹æ¡ˆ</h2>
            <p style="margin-bottom: 15px; color: #64748b;">
                å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½ä¸è¡Œï¼Œå°è¯•è¿™äº›å¤‡ç”¨æ–¹æ¡ˆã€‚
            </p>
            <div class="btn-grid">
                <button class="btn-primary" onclick="testWithDelay()">â±ï¸ å»¶è¿Ÿæ’­æ”¾ï¼ˆ500msï¼‰</button>
                <button class="btn-primary" onclick="testWithCancel()">ğŸš« å–æ¶ˆåæ’­æ”¾</button>
                <button class="btn-primary" onclick="testMultiple()">ğŸ“ æ’­æ”¾å¤šä¸ªçŸ­è¯­</button>
            </div>
            <div class="status status-info" id="altStatus">
                æœªæµ‹è¯•
            </div>
        </div>

        <!-- System Audio Test -->
        <div class="test-section">
            <h2>5ï¸âƒ£ ç³»ç»ŸéŸ³é¢‘æµ‹è¯•</h2>
            <div class="btn-grid">
                <button class="btn-purple" onclick="testSystemAudio()">ğŸ”Š æµ‹è¯• Beep éŸ³</button>
                <button class="btn-purple" onclick="testSpeechEngineState()">ğŸ” æ£€æŸ¥å¼•æ“çŠ¶æ€</button>
            </div>
            <div class="status status-info" id="systemStatus">
                æœªæµ‹è¯•
            </div>
        </div>

        <!-- Debug Console -->
        <div class="debug-console">
            <h3>ğŸ“‹ è°ƒè¯•æ—¥å¿—</h3>
            <div id="logContainer"></div>
        </div>
    </div>

    <script>
        let voices = [];
        let selectedVoice = null;
        let keepAliveInterval = null;
        let speechSynth = window.speechSynthesis;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('info', 'é¡µé¢åŠ è½½å®Œæˆ');
            loadVoices();
            speechSynth.onvoiceschanged = loadVoices;

            log('info', 'æµè§ˆå™¨: ' + navigator.userAgent.split(' ')[0]);
        });

        function loadVoices() {
            voices = speechSynth.getVoices();
            const select = document.getElementById('voiceSelect');
            const status = document.getElementById('voiceStatus');

            const zhVoices = voices.filter(v => v.lang.includes('zh') || v.lang.includes('CN'));

            if (zhVoices.length > 0) {
                select.innerHTML = zhVoices.map((v, i) =>
                    `<option value="${i}">${v.name} (${v.lang})</option>`
                ).join('');
                selectedVoice = zhVoices[0];
                status.textContent = `âœ… åŠ è½½äº† ${voices.length} ä¸ªè¯­éŸ³ï¼Œå…¶ä¸­ ${zhVoices.length} ä¸ªä¸­æ–‡è¯­éŸ³`;
                status.className = 'status status-success';
                log('success', `è¯­éŸ³åŠ è½½æˆåŠŸ: ${zhVoices.length} ä¸ªä¸­æ–‡è¯­éŸ³`);
                log('info', `é»˜è®¤é€‰æ‹©: ${selectedVoice.name}`);
            } else {
                status.textContent = 'âš ï¸ æœªæ‰¾åˆ°ä¸­æ–‡è¯­éŸ³';
                status.className = 'status status-error';
                log('warning', 'æœªæ‰¾åˆ°ä¸­æ–‡è¯­éŸ³');
            }
        }

        function updateSelectedVoice() {
            const select = document.getElementById('voiceSelect');
            const zhVoices = voices.filter(v => v.lang.includes('zh') || v.lang.includes('CN'));
            selectedVoice = zhVoices[parseInt(select.value)];
            log('info', `åˆ‡æ¢è¯­éŸ³: ${selectedVoice.name}`);
        }

        // Method A: Keep-Alive
        function startKeepAlive() {
            log('info', 'å¯åŠ¨ Keep-Alive æœºåˆ¶...');

            if (keepAliveInterval) {
                log('warning', 'Keep-Alive å·²ç»åœ¨è¿è¡Œ');
                return;
            }

            // Initial silent utterance
            const silentUtterance = new SpeechSynthesisUtterance('');
            silentUtterance.volume = 0;
            speechSynth.speak(silentUtterance);
            log('info', 'æ’­æ”¾é™éŸ³æ¿€æ´»å¼•æ“');

            // Keep alive every 14 seconds
            keepAliveInterval = setInterval(() => {
                const utterance = new SpeechSynthesisUtterance('');
                utterance.volume = 0;
                speechSynth.speak(utterance);
                log('info', 'Keep-Alive: æ’­æ”¾é™éŸ³ä¿æŒå¼•æ“æ´»è·ƒ');
            }, 14000);

            document.getElementById('startKeepAlive').disabled = true;
            document.getElementById('stopKeepAlive').disabled = false;
            document.getElementById('keepAliveStatus').textContent = 'âœ… è¿è¡Œä¸­ï¼ˆæ¯14ç§’åˆ·æ–°ï¼‰';
            document.getElementById('keepAliveStatus').className = 'status status-success';

            log('success', 'Keep-Alive å·²å¯åŠ¨');
        }

        function stopKeepAlive() {
            if (keepAliveInterval) {
                clearInterval(keepAliveInterval);
                keepAliveInterval = null;
            }

            speechSynth.cancel();

            document.getElementById('startKeepAlive').disabled = false;
            document.getElementById('stopKeepAlive').disabled = true;
            document.getElementById('keepAliveStatus').textContent = 'å·²åœæ­¢';
            document.getElementById('keepAliveStatus').className = 'status status-info';

            log('info', 'Keep-Alive å·²åœæ­¢');
        }

        function testKeepAlive() {
            if (!keepAliveInterval) {
                log('warning', 'è¯·å…ˆå¯åŠ¨ Keep-Alive');
                return;
            }

            log('info', 'æµ‹è¯•æ’­æ”¾ (Keep-Alive æ¨¡å¼)...');
            speakWithTracking('ä½ å¥½', selectedVoice);
        }

        // Method B: Full Reset
        function fullResetAndSpeak() {
            log('info', 'å®Œå…¨é‡ç½®è¯­éŸ³å¼•æ“...');

            // Cancel all
            speechSynth.cancel();
            log('info', 'å·²å–æ¶ˆæ‰€æœ‰è¯­éŸ³');

            // Wait a bit
            setTimeout(() => {
                log('info', 'æ’­æ”¾æµ‹è¯•è¯­éŸ³...');
                const utterance = new SpeechSynthesisUtterance('ä½ å¥½');

                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                    utterance.lang = selectedVoice.lang;
                }

                setupUtteranceHandlers(utterance, 'ä½ å¥½');

                speechSynth.speak(utterance);
                log('info', 'speak() è°ƒç”¨å®Œæˆ');
            }, 300);
        }

        function simpleSpeak() {
            log('info', 'ç®€å•æ’­æ”¾æµ‹è¯•ï¼ˆä¸­æ–‡ï¼‰...');
            const utterance = new SpeechSynthesisUtterance('ä½ å¥½');

            if (selectedVoice) {
                utterance.voice = selectedVoice;
                utterance.lang = selectedVoice.lang;
            }

            setupUtteranceHandlers(utterance, 'ä½ å¥½');

            const result = speechSynth.speak(utterance);
            log('info', `speak() è¿”å›: ${result}`);
        }

        function simpleSpeakEnglish() {
            log('info', 'ç®€å•æ’­æ”¾æµ‹è¯•ï¼ˆè‹±æ–‡ï¼‰...');
            const utterance = new SpeechSynthesisUtterance('Hello');

            setupUtteranceHandlers(utterance, 'Hello');

            const result = speechSynth.speak(utterance);
            log('info', `speak() è¿”å›: ${result}`);
        }

        // Method C: Alternative approaches
        function testWithDelay() {
            log('info', 'å»¶è¿Ÿæ’­æ”¾æµ‹è¯•ï¼ˆ500msï¼‰...');

            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance('ä½ å¥½');

                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }

                setupUtteranceHandlers(utterance, 'ä½ å¥½ï¼ˆå»¶è¿Ÿï¼‰');

                speechSynth.speak(utterance);
            }, 500);
        }

        function testWithCancel() {
            log('info', 'å–æ¶ˆåæ’­æ”¾æµ‹è¯•...');

            speechSynth.cancel();
            log('info', 'å·²å–æ¶ˆ');

            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance('ä½ å¥½');

                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }

                setupUtteranceHandlers(utterance, 'ä½ å¥½ï¼ˆå–æ¶ˆåï¼‰');

                speechSynth.speak(utterance);
            }, 100);
        }

        function testMultiple() {
            log('info', 'æ’­æ”¾å¤šä¸ªçŸ­è¯­æµ‹è¯•...');

            const phrases = ['ä½ å¥½', 'ä¸–ç•Œ', 'æµ‹è¯•'];
            let index = 0;

            const speakNext = () => {
                if (index >= phrases.length) {
                    log('success', 'æ‰€æœ‰çŸ­è¯­æ’­æ”¾å®Œæˆ');
                    document.getElementById('altStatus').textContent = 'âœ… å®Œæˆ';
                    document.getElementById('altStatus').className = 'status status-success';
                    return;
                }

                const phrase = phrases[index];
                log('info', `æ’­æ”¾ ${index + 1}/${phrases.length}: ${phrase}`);

                const utterance = new SpeechSynthesisUtterance(phrase);

                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }

                utterance.onend = () => {
                    log('success', `å®Œæˆ: ${phrase}`);
                    index++;
                    setTimeout(speakNext, 500);
                };

                utterance.onerror = (e) => {
                    log('error', `é”™è¯¯: ${e.error}`);
                    index++;
                    setTimeout(speakNext, 500);
                };

                speechSynth.speak(utterance);
            };

            speakNext();
        }

        // System tests
        function testSystemAudio() {
            log('info', 'æµ‹è¯•ç³»ç»ŸéŸ³é¢‘ (Web Audio API)...');

            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const audioCtx = new AudioContext();

                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);

                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.3);

                log('success', 'âœ… ç³»ç»ŸéŸ³é¢‘æˆåŠŸï¼èƒ½å¬åˆ° beep å£°å—ï¼Ÿ');
                document.getElementById('systemStatus').textContent = 'âœ… ç³»ç»ŸéŸ³é¢‘æ­£å¸¸';
                document.getElementById('systemStatus').className = 'status status-success';
            } catch (error) {
                log('error', 'âŒ ç³»ç»ŸéŸ³é¢‘å¤±è´¥: ' + error.message);
                document.getElementById('systemStatus').textContent = 'âŒ ç³»ç»ŸéŸ³é¢‘å¤±è´¥';
                document.getElementById('systemStatus').className = 'status status-error';
            }
        }

        function testSpeechEngineState() {
            const speaking = speechSynth.speaking;
            const pending = speechSynth.pending;
            const paused = speechSynth.paused;

            const state = `speaking=${speaking}, pending=${pending}, paused=${paused}`;
            log('info', `å¼•æ“çŠ¶æ€: ${state}`);
            document.getElementById('systemStatus').textContent = state;
            document.getElementById('systemStatus').className = 'status status-info';
        }

        // Helpers
        function speakWithTracking(text, voice) {
            const utterance = new SpeechSynthesisUtterance(text);

            if (voice) {
                utterance.voice = voice;
                utterance.lang = voice.lang;
            }

            setupUtteranceHandlers(utterance, text);
            speechSynth.speak(utterance);
        }

        function setupUtteranceHandlers(utterance, label) {
            utterance.onstart = () => {
                log('success', `âœ… å¼€å§‹æ’­æ”¾: ${label}`);
                if (label.includes('ä½ å¥½')) {
                    document.getElementById('simpleStatus').textContent = 'âœ… æ’­æ”¾ä¸­...';
                    document.getElementById('simpleStatus').className = 'status status-success';
                }
            };

            utterance.onend = () => {
                log('success', `âœ… æ’­æ”¾å®Œæˆ: ${label}`);
                if (label.includes('ä½ å¥½') && !label.includes('å»¶è¿Ÿ')) {
                    document.getElementById('simpleStatus').textContent = 'âœ… æ’­æ”¾æˆåŠŸ';
                    document.getElementById('simpleStatus').className = 'status status-success';
                }
            };

            utterance.onerror = (e) => {
                log('error', `âŒ é”™è¯¯: ${label} - ${e.error}`);
                document.getElementById('simpleStatus').textContent = 'âŒ é”™è¯¯: ' + e.error;
                document.getElementById('simpleStatus').className = 'status status-error';
            };
        }

        function log(type, message) {
            const container = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString();

            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span><span class="log-${type}">${message}</span>`;

            container.insertBefore(entry, container.firstChild);

            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }

            console.log(`[${type.toUpperCase()}] ${message}`);
        }
    </script>
</body>
</html>
