# 短期 vs 长期掌握区分方案

## TL;DR

> **核心目标**：区分「本轮短期标记」和「历史长期掌握」
> - 短期：每轮练习的临时错题标记，结束后清空显示状态
> - 长期：连续 5 天每天都答对 = 真掌握
> 
> **自动化程度**：全自动化，无需手动处理
> - 进入练习时：自动判断是否新的一天，清空短期标记
> - 练习过程中：自动记录当天第一次答题结果
> - 保存时：自动计算连续天数，更新掌握状态
> - 展示时：自动根据长期结果展示错题/掌握状态

---

## 背景与问题

### 当前问题
1. **标记混淆**：无法区分「本轮错题」和「历史错题」
2. **筛选失效**：筛选「仅错题」时，混入已掌握的题目
3. **逻辑不清**：短期标记和长期记录混在一起

### 用户期望
1. **筛选精准**：进入练习时，只展示真正的历史错题
2. **短期标记**：本轮练习中标记错题，结束后清空显示
3. **长期掌握**：连续 5 天每天都答对 = 真掌握，自动判断
4. **全自动化**：无需手动操作，系统自动记录和判断

---

## 需求定义（最终确认）

### 短期标记（本轮练习）
- **用途**：标记本轮练习中不会的题目
- **展示**：本轮练习中显示红勾标记
- **触发**：本轮「家长终测」中标记的红色
- **清空**：新的一天开始时，清空所有短期标记

### 长期记录（历史掌握）
- **规则**：连续 5 天每天都答对一次 → 标记为「掌握」
- **触发**：每天第一次答题的结果写入长期记录
- **重置**：某一天第一次答错 → 连续天数重置为 0

### 关键行为（最终确认）
1. **本轮结果判定**：只看「家长终测」保存的结果（markFinal）
2. **当天结果判定**：检查该词组在今天所有测试中是否标记过红色
   - 标记过一次 → 当天 "red"，打断连胜
   - 没标记过 → 当天 "green"，连续 +1
3. **保存时机**：点击「存档并结束」按钮时写入长期记录
4. **退出保护**：未保存退出时弹窗提示

### 数据结构设计

#### 长期记录（mastery 表）
```javascript
{
  id: "wordId",                    // 词组唯一标识
  history: ["green", "green", "red", "green", "green"],  // 历史记录（每天的结果）
  consecutive_green: 3,            // 当前连续绿色天数（>=5 = 掌握）
  last_practice_date: "2026-01-29", // 最后练习日期
  today_red_marked: false          // 追踪今天是否标记过红色（跨测试）
}
```

#### 短期标记（本轮练习状态）
```javascript
{
  id: "wordId",
  word: "词语",
  pinyin: "pīn yīn",
  temp_practice: "white" | "red",   // 本轮自由练习标记
  temp_self: "white" | "red",       // 本轮自测标记
  temp_final: "white" | "red" | "green"  // 本轮终测标记（决定性）
}
```

### 核心逻辑（最终版）

#### 1. 进入练习时（start 函数）
```javascript
const today = new Date().toISOString().split('T')[0];

// 判断是否新的一天
if (last_practice_date !== today) {
  // 新的一天，开始新的一天记录
  setMarkPractice('white');
  setMarkSelf('white');
  setMarkFinal('white');
  // 重置今天红色标记追踪
  setTodayRedMarked(false);
}

// 筛选错题（根据长期 result）
if (onlyWrong) {
  // 筛选条件：status === 'WEAK' 或没有历史记录
  filter(words => status === 'WEAK' || !history.length);
}
```

#### 2. 本轮练习中
```javascript
// 短期标记（显示用）
答错 -> setMarkXxx('red')    // 短期标记变红
答对 -> setMarkXxx('green')  // 短期标记变绿

// 追踪今天红色标记（跨测试）
当 markXxx 变为 'red' 时 -> today_red_marked = true;
```

#### 3. 保存/结束练习时（save 函数）
```javascript
const today = new Date().toISOString().split('T')[0];

if (last_practice_date !== today) {
  // 新的一天，写入新记录
  const todayResult = today_red_marked ? 'red' : 'green';
  history.push(todayResult);

  // 计算连续绿色天数
  if (todayResult === 'green') {
    consecutive_green += 1;
  } else {
    consecutive_green = 0;
  }

  last_practice_date = today;
} else {
  // 同一天：红色优先于绿色
  // 如果今天标记过红色，且当前结果不是 red，则更新为 red
  if (today_red_marked && history.slice(-1)[0] !== 'red') {
    history[history.length - 1] = 'red';
    consecutive_green = 0;  // 打断连胜
  }
  // 如果当前结果是 red，保持不变（绿色不能覆盖红色）
}

// 重置今天红色标记追踪
today_red_marked = false;

// 短期标记：保留显示状态，供用户查看
```

#### 4. 状态判断（getStatus 函数）
```javascript
// 基于 consecutive_green 判断掌握状态
if (consecutive_green >= 5) {
  return 'MASTERED';  // 连续 5 天都答对 = 掌握
} else if (history.length > 0 && history.slice(-1)[0] === 'red') {
  return 'WEAK';      // 最近一次是错题 = 弱
} else {
  return 'NEW';       // 新词或最近一次答对
}
```

### 案例验证（最终版）

#### 案例 1：连续 5 天答对 → 掌握

| 日期 | 测试 | markFinal | today_red_marked | 行为 | history | 连续天数 | 掌握状态 |
|------|------|-----------|------------------|------|---------|----------|----------|
| D1 | 第1轮 | green | false | 写入新记录 | `["green"]` | 1 | WEAK |
| D2 | 第1轮 | green | false | 写入新记录 | `["green", "green"]` | 2 | WEAK |
| D3 | 第1轮 | green | false | 写入新记录 | `["green", "green", "green"]` | 3 | WEAK |
| D4 | 第1轮 | green | false | 写入新记录 | `["green", "green", "green", "green"]` | 4 | WEAK |
| D5 | 第1轮 | green | false | 写入新记录 | `["green", "green", "green", "green", "green"]` | 5 | **MASTERED** |

#### 案例 2：中途答错 → 打断连胜

| 日期 | 测试 | markFinal | today_red_marked | 行为 | history | 连续天数 | 掌握状态 |
|------|------|-----------|------------------|------|---------|----------|----------|
| D1 | 第1轮 | green | false | 写入新记录 | `["green"]` | 1 | WEAK |
| D2 | 第1轮 | red | **true** | 写入新记录 | `["green", "red"]` | **0** | WEAK |
| D3 | 第1轮 | green | false | 写入新记录 | `["green", "red", "green"]` | **1** | WEAK |

#### 案例 3：红色优先于绿色

| 日期 | 测试 | markFinal | today_red_marked | 行为 | history | 连续天数 | 说明 |
|------|------|-----------|------------------|------|---------|----------|------|
| D1 | 第1轮 | green | false | 写入新记录 | `["green"]` | 1 | - |
| D1 | 第2轮 | red | **true** | **覆盖今天** | `["red"]` | **0** | 红色覆盖绿色 |
| D1 | 第3轮 | green | **true** | **保持红色** | `["red"]` | **0** | 绿色不能覆盖红色 |
| D2 | 第1轮 | green | false | 写入新记录 | `["red", "green"]` | **1** | 明天重新开始 |

**关键规则**：红色优先于绿色
- 一旦今天标记过红色，今天结果就是 "red"
- 即使后面都答对，今天结果也不会变成 "green"
- 只有明天才是新的机会

---

## 详细工作项

### 阶段 1：数据库迁移

- [ ] 1.1 添加 `last_practice_date` 字段到 `mastery` 表
  - 类型：date（YYYY-MM-DD 格式）
- [ ] 1.2 更新 `history` 字段含义
  - 原来是：每次练习的结果
  - 现在是：每天第一次练习的结果

### 阶段 2：数据初始化脚本

- [ ] 2.1 创建迁移脚本
  - 遍历所有 existing records
  - 如果没有 `last_practice_date`，设置为今天
  - 如果没有 `consecutive_green`，根据 `history` 计算

### 阶段 3：核心逻辑修改

- [ ] 3.1 修改 `start` 函数
  - 新增：判断是否新的一天
  - 新增：新的一天清空短期标记
  - 修改：错题筛选逻辑（基于长期 result）

- [ ] 3.2 修改 `getStatus` 函数
  - 基于 `consecutive_green >= 5` 判断掌握
  - 基于 `history.slice(-1)[0]` 判断是否错题

- [ ] 3.3 修改 `save` 函数
  - 新增：判断是否新的一天
  - 新增：写入历史记录
  - 新增：更新连续绿色天数
  - 新增：更新最后练习日期

- [ ] 3.4 修改 `processedUnits` 和 `DATA_BLUEPRINT`
  - 状态展示逻辑修改
  - 区分长期状态和短期状态

### 阶段 4：UI 展示修改

#### 4.1 展示设计方案（最终确认）

##### Setup页词汇总表

| 长期状态 | 文字颜色 | 下划线 | 说明 |
|----------|----------|--------|------|
| NEW（未测试） | 黑色 | 无 | 默认 |
| WEAK（错的/中断） | 红色 | **红色实线** | 当前方案 |
| MASTERED（掌握） | 绿色 | **绿色实线** | 当前方案 |

##### 练习页（开始做题前）

| 词组类型 | 文字颜色 | 框框 | 说明 |
|----------|----------|------|------|
| WEAK（未掌握） | **淡红色** | 白色 | 提示需要关注 |
| NEW / MASTERED | 黑色 | 白色 | 正常显示 |
| 本轮标记错 | 淡红 | **红色** | 本轮标记 |
| 本轮标记对 | 黑色 | **绿色** | 本轮标记 |

##### 闪卡模式

| 词组类型 | 文字颜色 | 说明 |
|----------|----------|------|
| WEAK（未掌握） | **淡红色** | 提示需要关注 |
| NEW / MASTERED | 黑色 | 正常显示 |
| 本轮错题 | **纯红色** | 当前方案，不改 |

#### 4.2 修改 setup 页面状态展示
- **WEAK 词**：红色实线下划线
- **MASTERED 词**：绿色实线下划线
- **NEW 词**：黑色，无标记

#### 4.3 修改练习页面状态展示
- **WEAK 词**：淡红色字着色
- **框框**：保留用于本轮标记
- **长期状态**：不特别处理（只强调未掌握）

#### 4.4 修改闪卡模式状态展示
- **WEAK 词**：淡红色字着色
- **本轮错题**：纯红色字（当前方案）
- **NEW/MASTERED**：正常显示

#### 4.5 优化「仅错题」筛选逻辑
- 基于长期 result 筛选（WEAK 状态）
- 排除已掌握的题目（MASTERED 状态）

### 阶段 5：测试验证

- [ ] 5.1 测试新的一天进入逻辑
  - 清空短期标记
  - 开始新的一天记录

- [ ] 5.2 测试短期标记逻辑
  - 答错变红，答对变绿
  - 本轮结束后保留显示

- [ ] 5.3 测试长期记录逻辑
  - 当天第一次答错写入 red
  - 当天第一次答对写入 green
  - 连续 5 天 green = 掌握

- [ ] 5.4 测试状态判断
  - consecutive_green >= 5 = 掌握
  - 最近一次 red = 弱
  - 无历史 = 新词

### 阶段 6：文档更新

- [ ] 6.1 更新 AGENTS.md
  - 记录新的数据结构
  - 记录新的逻辑规则
- [ ] 6.2 更新错题集
  - 记录本次改动的背景和原因
- [ ] 6.3 更新 PROJECT_STATUS.md
  - 记录当前状态和进度

---

## 关键代码位置

| 功能 | 文件 | 行号范围 | 说明 |
|------|------|----------|------|
| `start` 函数 | `src/App.jsx` | ~534-545 | 练习开始逻辑 |
| `save` 函数 | `src/App.jsx` | ~547-565 | 保存逻辑 |
| `getStatus` 函数 | `src/App.jsx` | ~508-512 | 状态判断逻辑 |
| `processedUnits` | `src/App.jsx` | ~493-506 | 单元数据处理 |
| `DATA_BLUEPRINT` | `src/App.jsx` | ~10-34 | 硬编码数据 |

---

## 验证策略

### 自动化验证（Playwright）

```javascript
// 测试场景 1：新的一天进入
1. 进入练习，标记一些错题
2. 修改系统日期为明天
3. 重新进入练习
4. 验证：短期标记已清空
5. 验证：长期记录未变化

// 测试场景 2：短期标记
1. 进入练习
2. 标记一些错题
3. 刷新页面
4. 验证：短期标记保留

// 测试场景 3：长期记录
1. 连续 5 天练习，都答对
2. 验证：第 5 天后状态变为「掌握」
3. 第 6 天答错一次
4. 验证：状态变为「弱」，连胜重置
```

### 手动验证清单

- [ ] 进入练习时，根据长期 result 正确筛选错题
- [ ] 本轮练习中，短期标记正常工作
- [ ] 保存时，正确写入长期记录
- [ ] 新的一天进入时，短期标记清空
- [ ] 连续 5 天答对后，状态变为掌握
- [ ] 答错后，连续天数重置
- [ ] 状态展示与实际逻辑一致

#### 展示验证清单

- [ ] **Setup页**：WEAK=红色实线，MASTERED=绿色实线，NEW=黑色无标记
- [ ] **练习页**：WEAK词=淡红色字，框框=本轮标记用
- [ ] **闪卡模式**：WEAK词=淡红色字，本轮错题=纯红色字
- [ ] **仅错题筛选**：只显示 WEAK 状态的词

---

## 风险与注意事项

### 风险
1. **数据迁移**：现有数据的 `history` 字段需要重新解释
2. **边界情况**：跨时区、日期变更时的处理
3. **兼容性**：旧数据和新逻辑的兼容

### 注意事项
1. **先备份**：执行迁移脚本前，先备份数据库
2. **灰度发布**：先在小范围用户中测试
3. **回滚方案**：保留回滚到旧逻辑的能力

---

## 预期效果

### Before
- 无法区分短期和长期标记
- 筛选「仅错题」不准确
- 掌握状态计算逻辑混乱

### After
- 短期标记 = 本轮练习的临时标记
- 长期记录 = 连续 5 天每天都答对
- 筛选精准：只展示真正的历史错题
- 全自动化：系统自动记录和判断

---

## 里程碑

| 阶段 | 预计工作量 | 验收标准 |
|------|------------|----------|
| 数据库迁移 | 0.5 小时 | 字段添加成功，数据初始化完成 |
| 核心逻辑修改 | 2 小时 | start/save/getStatus 函数修改完成 |
| UI 展示修改 | 1 小时 | 状态展示正确，筛选精准 |
| 测试验证 | 1 小时 | 所有场景测试通过 |
| 文档更新 | 0.5 小时 | 文档同步更新 |

**总计**：约 5 小时

---

## 下一步行动

1. 确认方案细节
2. 准备数据库迁移脚本
3. 开始实施阶段 1：数据库迁移

---

## 📋 对下一个模型的重要提示

### 项目基本信息
- **项目名称**：kanpinyinxieci_semiauto（拼音听写练习应用）
- **用户**：老毛（1986年生，小学三年级学生家长）
- **技术栈**：React 18 + Vite + Tailwind CSS + Supabase
- **语言**：纯 JavaScript（无 TypeScript）
- **入口文件**：`src/main.jsx` → `src/App.jsx`

### 启动方式
```bash
cd /Users/mao/Documents/Coding/Development/Projects/Web/kanpinyinxieci_semiauto
npm run dev  # 端口 3009
```

### 数据库管理
- **Supabase 项目**：`https://ynasoxvdalcmcmrsxxmjr.supabase.co`
- **mastery 表**：存储词组掌握记录
- **相关文件**：`AGENTS.md`（用户信息）、`SUPABASE_SETUP.md`（配置说明）

### 执行顺序
1. **先读文件**：完整阅读 `short-term-vs-long-term-mastery.md` 和 `short-term-vs-long-term-cases.md`
2. **再读代码**：阅读 `src/App.jsx` 理解现有实现
3. **后执行**：按工作项顺序执行（阶段1→阶段6）
4. **边改边测**：每个阶段完成后运行 `npm run dev` 测试

### 关键变量名
- `mastery` - 全局掌握状态
- `temp_state` - 本轮练习状态（短期标记）
- `history` - 每天练习结果数组
- `consecutive_green` - 连续绿色天数
- `last_practice_date` - 最后练习日期
- `today_red_marked` - 今天是否标记过红色

### 红色优先规则（最重要）
```
一旦今天标记过红色，今天结果就是 "red"（不可逆）
绿色不能覆盖红色
只有明天才是新的机会
```
