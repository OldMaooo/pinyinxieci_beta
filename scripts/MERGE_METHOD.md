# 词库合并方法文档

## 背景

原始数据来自PDF教材，有两个表：
- **写字表**：单字（1-25课）
- **词语表**：多字词（部分课）

## 合并规则

**最终总表 = 词语表（全部） + 写字表（去重后转成词）**

### 处理逻辑

| 写字表中的字 | 是否已在词语表中 | 处理方式 |
|-------------|-----------------|---------|
| "诗" | ❌ | 转成词 "古诗" |
| "冲" | ✅ "冲动"中 | 跳过 |
| "碧" | ✅ "碧绿"中 | 跳过 |

### 每个课的处理

1. 收集词语表中该课的所有词
2. 遍历写字表的字：
   - 如果字已在任何词语中（包含关系）→ 跳过
   - 如果不在 → 用 `charToWordMap` 转成双字词
3. 去重后输出

## 课名处理

- 写字表：1-25课（完整）
- 词语表：2-14, 16-25 + 识字1-4
- **总表课名**：取并集并排序

### 排序规则

使用 `parseLessonKey` 函数统一排序：

| 课类型 | 排序优先级 | 生成key示例 |
|--------|-----------|------------|
| 单元N | 0（最高，一年级专用） | 单元1 → "000" |
| 阅读N | 1 | 阅读1 → "100" |
| 数字N | 2 | 1 → "002" |
| 识字N | 3 | 识字1 → "200" |
| 语文园地N | 4（最低） | 语文园地一 → "300" |

**注意**：所有key统一用 `padStart(3, '0')` 补齐，确保字符串比较正确排序

## 使用方法

```bash
# 生成纯净版MD和JSON
node scripts/merge-final-table.cjs AI_Data_Generation_Kit/intermediate_data/[年级册次].md [年级册次]

# 示例：生成二年级下册
node scripts/merge-final-table.cjs AI_Data_Generation_Kit/intermediate_data/二年级下册.md 二年级下册
```

## 输出文件

- `scripts/extracted-final-tables/[年级册次]-纯净版.md` - 纯净版MD
- `dist/data/[年级册次].json` - 词库JSON

## 词数统计

| 学期 | 词数 | 状态 |
|------|------|------|
| 一年级上册 | 106 | ✅ 已完成 |
| 一年级下册 | 194 | ✅ 已完成 |
| 二年级上册 | 372 | ✅ 已完成 |
| 二年级下册 | 353 | ✅ 已完成 |
| 三年级上册 | 208 | 待生成 |
| 三年级下册 | 214 | 待生成 |

## 注意事项

1. **课1和课15**：词语表没有，只有写字表
2. **识字1-4**：需要额外处理生字转词
3. **字符映射表**：`charToWordMap` 需要持续维护完善

## 一年级特殊模式

一年级采用**仅写字表**模式，不合并词语表：

- **总表来源**：仅使用写字表
- **转词规则**：所有单字必须转成双字词（一年级不做单字听写）
  - 用 `charToWordMap` 优先转成简单常用词
  - 确保词组简单，一年级小学生能写

```bash
# 一年级使用相同命令，脚本会自动检测
node scripts/merge-final-table.cjs AI_Data_Generation_Kit/intermediate_data/一年级下册.md 一年级下册
```

**示例**：
- 写字表字："春" → 输出词："春节"（简单常用词）
- 写字表字："入" → 输出词："进入"（组成动词）
- 写字表字："什" → 输出词："什么"（疑问词）

**验证**：确保输出中不存在单字（词长度=1）

## 常见问题排查

### 课顺序错误（如 1, 10, 11... 2, 3）

**症状**：数字课没有按正确顺序排列（"10" 排在 "2" 前面）

**原因**：`generateJSON` 函数可能使用了错误的排序逻辑

**排查**：
```bash
# 检查生成的课顺序
node -e "
const data = JSON.parse(require('fs').readFileSync('dist/data/二年级上册.json', 'utf8'));
const units = [...new Set(data.wordBank.map(w => w.unit))];
units.forEach((u, i) => console.log((i+1) + '. ' + u));
"

# 预期输出（二年级上册）：
# 1. 阅读1 ... 23. 阅读23
# 24. 识字1 ... 27. 识字4
# 28. 语文园地一 ... 35. 语文园地八
```

**修复**：`generateJSON` 函数必须调用 `parseLessonKey` 进行排序
